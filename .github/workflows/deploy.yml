name: 部署网站工作流（gh-pages）

on:
  # 手动触发部署
  # Manually trigger deployment
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          # 拉取所有提交记录，以支持完整的 Git 操作
          # Fetch all commit history for full Git operations
          fetch-depth: 0

      # 验证 DEPLOY_KEY 是否存在
      - name: Verify DEPLOY_KEY exists
        run: |
          if [ -z "${{ secrets.DEPLOY_KEY }}" ]; then
            echo "ERROR: DEPLOY_KEY secret is not set. Please configure the DEPLOY_KEY secret in your repository settings."
            exit 1
          fi
          echo "DEPLOY_KEY is configured"

      # 设置 SSH
      # Setup SSH
      - name: Setup SSH for git access
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      # 部署到另一个仓库并触发 GitHub Pages 构建
      # Deploy to another repository and trigger GitHub Pages build
      - name: Push to another repository
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 创建临时目录以避免与当前 Git 工作区冲突
          mkdir temp_target
          cd temp_target
          
          # 克隆目标仓库
          git clone git@github.com:Luo202044/ClassIn.git --branch gh-pages .
          
          # 保存原始的 .nojekyll 和 CNAME 文件（如果存在）以防丢失
          cp .nojekyll ../.nojekyll.backup 2>/dev/null || echo ".nojekyll not found"
          cp CNAME ../CNAME.backup 2>/dev/null || echo "CNAME not found"
          
          # 清空目标仓库内容（保留 .git 文件夹）
          git rm -rf .
          
          # 恢复 .nojekyll 和 CNAME 文件
          cp ../.nojekyll.backup .nojekyll 2>/dev/null || echo "Creating new .nojekyll"
          touch .nojekyll  # 确保 .nojekyll 文件存在，这对于 GitHub Pages 很重要
          cp ../CNAME.backup CNAME 2>/dev/null || echo "CNAME file not restored"
          
          # 从原始工作目录复制所有文件到目标仓库
          cd ..
          # 复制所有文件和目录，包括隐藏文件（除了 .git 目录）
          rsync -av --exclude='.git' --exclude='temp_target' . temp_target/
          cd temp_target
          
          # 添加所有文件并提交
          git add .
          git commit -m "Deploy from ${{ github.repository }} ${{ github.sha }}" || echo "No changes to commit"
          git push origin gh-pages
          
      # 等待 GitHub Pages 构建完成
      - name: Wait for GitHub Pages build
        run: |
          echo "Waiting for GitHub Pages to build..."
          sleep 10  # 等待一段时间让 GitHub Pages 开始构建
          
      # 验证 GitHub Pages 是否可访问
      - name: Verify GitHub Pages deployment
        run: |
          # 获取目标仓库的 GitHub Pages URL
          PAGES_URL="https://luo202044.github.io/ClassIn"
          echo "Checking if GitHub Pages is available at $PAGES_URL"
          curl -f --retry 5 --retry-delay 10 "$PAGES_URL" || echo "GitHub Pages might still be building, please check manually"
